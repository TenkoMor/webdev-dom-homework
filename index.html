<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="list">
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="name-input" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="comment-input"></textarea>
      <div class="add-form-row">
        <button class="button" id="add-button">Написать</button>
      </div>
    </div>
    <button class="button" id="delete-button">Удалить последний комментарий</button>
  </div>
</body>

<script>
  "use strict";
  const buttonElement = document.getElementById("add-button");
  const listElement = document.getElementById("list");
  const nameInputElement = document.getElementById("name-input");
  const commentInputElement = document.getElementById("comment-input");
  const delButtonElement = document.getElementById("delete-button");

  const postingDate = () => {
    const date = new Date();
    return `${Intl.DateTimeFormat('ru-RU', { day: 'numeric', month: 'numeric', year: '2-digit' }).format(date)} ${Intl.DateTimeFormat('ru-RU', { timeStyle: 'short' }).format(date)}`;
  };

  const comments = [
    {
      name: 'Глеб Фокин',
      date: '12.02.22 12:18',
      comment: 'Это будет первый комментарий на этой странице',
      likes: 3,
      like: false
    },
    {
      name: 'Варвара Н.',
      date: '13.02.22 19:22',
      comment: 'Мне нравится как оформлена эта страница! ❤',
      likes: 75,
      like: false
    }
  ];

  const likeButtonWork = () => {
    const likeButtonsElements = document.querySelectorAll(".like-button");

    for (const likeButtonElement of likeButtonsElements) {
      likeButtonElement.addEventListener("click", () => {
        const index = likeButtonElement.dataset.index;
        const comm = comments[index];
        
        if (comm.like === false) {
          comm.like = true;
          comm.likes += 1;
          comm.isActive = '-active-like';
        } else if (comm.like === true) {
          comm.like = false;
          comm.likes -= 1;
          delete comm.isActive;
        };

        renderComments();
        event.stopPropagation();
      });
    };
  };

  const replyComment = () => {
    const commentsElements = document.querySelectorAll(".comment");

    for (const comment of commentsElements){
      const index = comment.dataset.index;
      comment.addEventListener("click", () => {
        const elsesComment = comments[index].comment;
        commentInputElement.value =`> ${comments[index].name}
"${elsesComment}" <
`;
      });
    };
  };

  const safeHtmlString = (str) => {
    return str.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");
  };

  const renderComments = () => {
    const commentsHtml = comments.map((user, index) => {
      return `<li class="comment" data-index="${index}">
          <div class="comment-header">
            <div>${user.name}</div>
            <div>${user.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${user.comment}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${user.likes}</span>
              <button class="like-button ${user.isActive}" data-index="${index}"></button>
            </div>
          </div>
        </li>`;
    }).join('');

    listElement.innerHTML = commentsHtml;

    likeButtonWork();
    replyComment();
  };

  renderComments();

  buttonElement.disabled = true;

  addEventListener("input", (event) => {
    if (nameInputElement.value == "" || commentInputElement.value == "") {
      buttonElement.disabled = true;
    };
    if (nameInputElement.value != "" && commentInputElement.value != "") {
      buttonElement.disabled = false;
    };
  });

  buttonElement.addEventListener("click", () => {
    comments.push({
      name: safeHtmlString(nameInputElement.value),
      date: postingDate(),
      comment: safeHtmlString(commentInputElement.value),
      likes: 0,
      like: false
    })

    renderComments();

    nameInputElement.value = "";
    commentInputElement.value = "";
    buttonElement.disabled = true;
  });

  delButtonElement.addEventListener("click", () => {
    comments.pop();
    renderComments();
  });

  console.log("It works!");
</script>

</html>